{% extends "base.html" %}
{% load static %}
{% block title %}Pos{% endblock title %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Order Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 px-4">
                <main role="main" class="col-md-9 ml-sm-auto col-lg-9 px-4">
                    <div class="d-flex flex-column flex-md-nowrap pt-3 pb-2">
                        <h1 class="h5 fw-bold">Categories</h1>
                        <div class="row">
                            <!-- Category Items -->
                            <div class="col-md-2">
                                <div class="card mb-4 box-shadow">
                                    <div class="card-img-top bx bx-bowl-rice text-center fs-2 mt-2"></div>
                                    <div class="card-body text-center">
                                        <p class="card-text">Food</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card mb-4 box-shadow">
                                    <div class="card-img-top bx bx-drink text-center fs-2 mt-2"></div>
                                    <div class="card-body text-center">
                                        <p class="card-text">Drinks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt- pb-2 mb-3 border-bottom">
                        <h1 class="h5 fw-bold">Meals</h1>
                    </div>
                    <div class="row">
                        <!-- Menu Items -->
                        {% for meal in meals %}
                            <div class="col-md-3">
                                <div class="card mb-4 box-shadow">
                                    <div class="card-body">
                                        <p class="card-text">{{ meal.name }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addToCart({{ meal.id }}, '{{ meal.name }}', {{ meal.price }})">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </main>
            </main>
            <section class="col-md-3 bg-light sidebar">
                <div class="p-3">
                    <h5 class="fw-bold">Order Details</h5>
                    <div id="orderDetails" style="height:300px"></div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Sub Total</span>
                        <span id="subTotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tax</span>
                        <span id="tax">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total</span>
                        <span id="total">$0.00</span>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-danger w-100" id="cancelBtn">Cancel</button>
                    </div>
                    <div class="d-flex justify-content-center mt-3">
                        <button class="btn btn-success w-100" id="chargeButton">Charge $0.00</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="chargeModal" tabindex="-1" aria-labelledby="chargeModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chargeModalLabel">Finalize Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="totalAmountInput" class="form-label">Total Amount</label>
                        <input type="number" class="form-control" id="totalAmountInput" placeholder="Enter total amount received">
                    </div>
                    <div class="mb-3">
                        <label for="changeDisplay" class="form-label">Change</label>
                        <input type="text" class="form-control" id="changeDisplay" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="finalizeSale()">Finalize Sale</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'scripts.js' %}"></script>
    <script>
        const VAT_RATE = 0.15;
        let cart = [];

        const chargeModal = new bootstrap.Modal(document.getElementById('chargeModal'))

        document.getElementById('cancelBtn').addEventListener('click', ()=>{
            cart = []
            updateOrderDetails();
            Swal.fire({
                title: "Success",
                text: "Order Cart Refreshed",
                icon: "success"
            });
        })

        document.getElementById('chargeButton').addEventListener('click', ()=>{
            if (cart.length === 0){
                Swal.fire({
                    title: "Error",
                    text: "Empty Order",
                    icon: "error"
                });
            }else{
                chargeModal.show()
            }
        })
    
        function addToCart(id, name, price) {
          const existingMeal = cart.find(meal => meal.id === id);
          if (existingMeal) {
            existingMeal.quantity += 1;
          } else {
            const meal = { id, name, price, quantity: 1 };
            cart.push(meal);
          }
          updateOrderDetails();
        }
        
        function updateOrderDetails() {
            const orderDetails = document.getElementById('orderDetails');
            orderDetails.innerHTML = '';
          
            let subTotal = 0;
          
            cart.forEach(meal => {
              const mealRow = document.createElement('div');
              mealRow.className = 'd-flex justify-content-between align-items-center';
          
              const removeIcon = document.createElement('i');
              removeIcon.classList.add('bx', 'bx-trash'); 
              removeIcon.addEventListener('click', () => {
                removeFromCart(meal.id);
              });
          
              mealRow.appendChild(removeIcon);
          
              const nameQuantityContainer = document.createElement('div');
              nameQuantityContainer.className = 'meal-details';
          
              const mealName = document.createElement('span');
              mealName.innerText = meal.name;
              nameQuantityContainer.appendChild(mealName);
          
              const mealQuantity = document.createElement('span');
              mealQuantity.innerText = ` (x${meal.quantity})`;
              nameQuantityContainer.appendChild(mealQuantity);
          
              mealRow.appendChild(nameQuantityContainer);
          
              const mealPrice = document.createElement('span');
              mealPrice.innerText = `$${(meal.price * meal.quantity).toFixed(2)}`;
              mealRow.appendChild(mealPrice);
          
              orderDetails.appendChild(mealRow);
              subTotal += meal.price * meal.quantity;
        });
          
            const total = subTotal;
            const subTotalExclTax = total / (1 + VAT_RATE);
            const tax = total - subTotalExclTax;
          
            document.getElementById('subTotal').innerText = `$${subTotalExclTax.toFixed(2)}`;
            document.getElementById('tax').innerText = `$${tax.toFixed(2)}`;
            document.getElementById('total').innerText = `$${total.toFixed(2)}`;
            document.getElementById('chargeButton').innerText = `Charge $${total.toFixed(2)}`;
          }
          

    function finalizeSale() {
        const totalAmountInput = parseFloat(document.getElementById('totalAmountInput').value);
        const total = parseFloat(document.getElementById('total').innerText.slice(1));
        const change = totalAmountInput - total;
        document.getElementById('changeDisplay').value = `$${change.toFixed(2)}`;

        if(!totalAmountInput){
            Swal.fire({
                title: "Error",
                text: "Please Insert Amount.",
                icon: "error"
            });
            return;
        }
    
        const saleData = {
            received_amount: totalAmountInput,
            items: cart.map(meal => ({
                meal_id: meal.id,
                quantity: meal.quantity,
                price: meal.price
            }))
        };
    
        fetch('{% url "pos:process_sale" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(saleData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Sale processed successfully:', data);
                Swal.fire({
                    title: "Success",
                    text: "Processing Receipt",
                    icon: "success"
                });
                cart = []
                updateOrderDetails();
                chargeModal.hide()
            } else {
                Swal.fire({
                    title: "Error",
                    text: data.message,
                    icon: "error"
                });
                chargeModal.hide()
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    

    document.getElementById('totalAmountInput').addEventListener('input', () => {
        const totalAmountInput = parseFloat(document.getElementById('totalAmountInput').value);
        const total = parseFloat(document.getElementById('total').innerText.slice(1));
        const change = totalAmountInput - total;
        document.getElementById('changeDisplay').value = `$${change.toFixed(2)}`;
    });

    </script>
</body>
</html>
{% endblock %}
